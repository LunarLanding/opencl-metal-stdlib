//
//  metal_stdlib.h
//  SIMDFromOpenCL
//
//  Created by Philip Turner on 2/26/23.
//

#ifndef metal_stdlib_h
#define metal_stdlib_h

#define EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, C_TYPE, AIR_TYPE) \
__attribute__((__overloadable__)) C_TYPE EXPR(C_TYPE data) \
  __asm("air." #EXPR "." #AIR_TYPE); \

#define EXPOSE_FUNCTION_SCALAR_ARGS_1(EXPR) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, char, s.i8) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, short, s.i16) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, int, s.i32) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, uchar, u.i8) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, ushort, u.i16) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, uint, u.i32) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, float, f32) \

#define EXPOSE_FUNCTION_VECTOR_ARGS_1(EXPR, VEC_SIZE) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, char##VEC_SIZE, s.v##VEC_SIZE##i8) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, short##VEC_SIZE, s.v##VEC_SIZE##i16) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, int##VEC_SIZE, s.v##VEC_SIZE##i32) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, uchar##VEC_SIZE, u.v##VEC_SIZE##i8) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, ushort##VEC_SIZE, u.v##VEC_SIZE##i16) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, uint##VEC_SIZE, u.v##VEC_SIZE##i32) \
EXPOSE_FUNCTION_OVERLOAD_ARGS_1(EXPR, float##VEC_SIZE, v##VEC_SIZE##f32) \

#define EXPOSE_FUNCTION_ARGS_1(EXPR) \
EXPOSE_FUNCTION_SCALAR_ARGS_1(EXPR) \
EXPOSE_FUNCTION_VECTOR_ARGS_1(EXPR,2) \
EXPOSE_FUNCTION_VECTOR_ARGS_1(EXPR,3) \
EXPOSE_FUNCTION_VECTOR_ARGS_1(EXPR,4) \

#define BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, C_TYPE) \
__attribute__((__overloadable__)) \
C_TYPE OPENCL_EXPR(C_TYPE x) { \
  return METAL_EXPR(x); \
}

#define BRIDGE_FUNCTION_SCALAR_ARGS_1(METAL_EXPR, OPENCL_EXPR) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, char) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, uchar) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, short) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, ushort) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, int) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, uint) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, float) \

#define BRIDGE_FUNCTION_VECTOR_ARGS_1(METAL_EXPR, OPENCL_EXPR, VEC_SIZE) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, char##VEC_SIZE) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, uchar##VEC_SIZE) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, short##VEC_SIZE) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, ushort##VEC_SIZE) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, int##VEC_SIZE) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, uint##VEC_SIZE) \
BRIDGE_FUNCTION_OVERLOAD_ARGS_1(METAL_EXPR, OPENCL_EXPR, float##VEC_SIZE) \

#define BRIDGE_FUNCTION_ARGS_1(METAL_EXPR, OPENCL_EXPR) \
BRIDGE_FUNCTION_SCALAR_ARGS_1(METAL_EXPR, OPENCL_EXPR) \
BRIDGE_FUNCTION_VECTOR_ARGS_1(METAL_EXPR, OPENCL_EXPR, 2) \
BRIDGE_FUNCTION_VECTOR_ARGS_1(METAL_EXPR, OPENCL_EXPR, 3) \
BRIDGE_FUNCTION_VECTOR_ARGS_1(METAL_EXPR, OPENCL_EXPR, 4) \

EXPOSE_FUNCTION_ARGS_1(simd_sum)
BRIDGE_FUNCTION_ARGS_1(simd_sum, sub_group_reduce_add)
EXPOSE_FUNCTION_ARGS_1(simd_prefix_inclusive_sum)
BRIDGE_FUNCTION_ARGS_1(simd_prefix_inclusive_sum, sub_group_scan_inclusive_add)

#undef BRIDGE_FUNCTION_ARGS_1
#undef BRIDGE_FUNCTION_VECTOR_ARGS_1
#undef BRIDGE_FUNCTION_SCALAR_ARGS_1
#undef BRIDGE_FUNCTION_OVERLOAD_ARGS_1
#undef EXPOSE_FUNCTION_ARGS_1
#undef EXPOSE_FUNCTION_VECTOR_ARGS_1
#undef EXPOSE_FUNCTION_SCALAR_ARGS_1
#undef EXPOSE_FUNCTION_OVERLOAD_ARGS_1

#endif /* metal_stdlib_h */
